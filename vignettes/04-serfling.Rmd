---
title: "Serfling Model Background"
author: "Kevin W. McConeghy"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{flumodelr: 04-Serfling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: flumodelr.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(tibble.print_min = 4L, tibble.print_max = 4L)
library(tidyverse)
library(lubridate)
library(scales)
library(flumodelr)
```

The primary method paper was a 1963 paper published by Robert Serfling working for the Centers for Disease Control and Prevention.  

[Serfling RE. Methods for current statistical analysis of excess pneumonia-influenza deaths. Public Health Rep. 1963 Jun; 78(6): 494 - 506.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1915276/)

The paper outlines a strategy for estimating what proportion of deaths are due to influenza. The underlying issue is that many deaths reported due to influenza and pneumonia may be due to other causes, while many deaths attritable other causes may be due to influenza. The primary goal was to develop a "standard curve of expected seasonal mortality". The concept was that an individual could use historical data to estimate seasonal trends in influenza. Then for a given place-time an researcher could evaluate how many deaths occurred in excess of this baseline rate. Much of the original paper is of little interest given modern computing methods, but the basic concept persists as a reasonable approach to estimating "flu" deaths.      

## Influenza  
Critically, it should be understood that influenza epidemics are highly seasonal with spikes in the winter months, commonly January - February. This seasonality leads to a cyclical rate of influenza morbidity and mortality.  
```{r, echo=F, results='asis', fig.width=7}
fludta <- flumodelr::fludta

g1 <- ggplot(fludta, aes(x=yrweek_dt, y=perc_fludeaths)) + 
  geom_line(size=0.8, colour="#CC0000") +
  scale_x_date(labels = date_format("%Y"), date_breaks="1 year",
               expand=c(0, .9)) + 
  xlab("Year") + 
  ylab("% of Deaths from P&I") + 
  theme_light(base_size=16) +
  theme(plot.title = element_text(size=14)) +
  labs(title="Figure 1. Pneumonia and Influenza Mortality")
g1
```

It was noted by early researchers that the rate of reported deaths (red line), may be modeled by a trigonomic function. 

## Linear and Cyclical Regression Models 

The classical ordinary least squares framework is often described in matrix notation as:  
$$y_i = X_i\beta + u_{i} \quad \textrm{where} \quad i = 1,..,n$$

Where $y$ is a dependent variable, $X$ is a vector of regressors (i.e. independent variables) with $k$-dimensions, $\beta$ is a vector of the coefficients for $X$, and $u$ is the residual error term.  often simply as: $y= X\beta+u$.  

Given a simple additive model with one independent variable t:
$$Eq \ 1. \  y = \alpha_0 + \beta_1*t_1 + u$$

Let t, be the unit of time in figure 1 (week = 1, week=2, ...).  The above model is inadequate, and will poorly fit the data (figure) because the secular trend is non-linear.  
```{r, echo=F, results='asis', fig.width=7}
g1 <- ggplot(fludta, aes(x=yrweek_dt, y=perc_fludeaths)) + 
  geom_line(size=0.8, colour="#CC0000") +
  geom_smooth(method='lm') +
  scale_x_date(labels = date_format("%Y"), date_breaks="1 year",
               expand=c(0, .9)) + 
  xlab("Year") + 
  ylab("% of Deaths from P&I") + 
  theme_light(base_size=16) +
  theme(plot.title = element_text(size=14)) +
  labs(title="Figure 2. Pneumonia and Influenza Deaths Over Time",
       caption="Ordinary Least Squares")
g1
```
  
Early investigators such as Serfling proposed that a Fourier term be added to model the cycle like so:
$$Eq \ 2. \  y = \alpha_0 + \beta_1*t + sine(\frac{2 \pi t}{52}) + cos(\frac{2 \pi t}{52}) + u$$
The original paper used 4-week periods so the period denominator is 13. The waveform will be approximately sawtooth if t resets within a period (0-52). If t is continuous it will be a smooth curve. This allows us to use a linear model which accounts for the cyclical nature of the disease.  The original paper recommends one [Fourier term](https://en.wikipedia.org/wiki/Fourier_series).   

## Example. Fitted line (one Fourier term)   
```{r , results='as.is', fig.width=7}
## Add fourier term
fit <- fludta %>%
  mutate(week2 = row_number(),
         theta = 2*week2/52,
         sin_f1 = sinpi(theta),
         cos_f1 = cospi(theta),
         pred_y = predict( lm(perc_fludeaths ~ 
                                week2 + sin_f1 + cos_f1, data=.)))
```

```{r, echo=F, results='as.is', fig.width=7}
g1 <- ggplot(fit, aes(x=yrweek_dt)) + 
  geom_line(aes(y=perc_fludeaths), size=0.8, colour="#CC0000") +
  geom_line(aes(y=pred_y), size=0.8, colour="black") +
  scale_x_date(labels = date_format("%Y"), date_breaks="1 year",
               expand=c(0, .9)) + 
  xlab("Year") + 
  ylab("% of Deaths from P&I") + 
  theme_light(base_size=16) +
  theme(plot.title = element_text(size=14)) +
  labs(title="Figure 3. Pneumonia and Influenza Mortality",
       caption="Serfling Model")
g1
```

A single Fourier term does a reasonable job approximating the secular trend of disease, except notably during severe influenza epidemics.  The black solid line represents a single Fourier term.  

During certain seasons, there is a pronounced spike above the predicted (fit) line. For example in the 12-13, 13-14 and 14-15 seasons.  These can be subjectively considered severe influenza epidemics. However a goal could be to define objective criteria for epidemics. Such as any time-period 1.64 standard deviations above the fitted line representing a time of severe influenza morbidity and mortality, requiring significant public health intervention.    

## Estimation approach for attributable or "excess" mortality   

The serfling paper describes 4 steps:

 * Estimate secular trend  
 * Remove trend from data  
 * Estimate seasonal change from adjusted data  
 * Restore trend component  
 
In this package we operationalize this like so:

 * Construct a time-series dataset, with a variable for a flu outcome (i.e. deaths, hospitalizations).  
 * Estimate a cyclical regression as above; 
  * Fit a trend line  (solid black line)  
  * predict epidemic threshold (dashed black line)  
 * Observations falling outside the dashed black line are "excess"  
  * Quantify values in excess of threshold    

## Step-wise example  
The flumodelr function fluserf will perform the above steps. We present the individual steps here for demonstration. 

It is assumed the influenza epidemic period begins Oct. 1st, and ends May 31st. This is a conventional "flu" season in the U.S. However individual areas / regions may justify tailored periods. These assumptions are modifiable as options in the regression function.  

### Step 1. Formatted influenza data  
To compute a traditional Serfling model. The input dataframe must have time vector, indicator for the epidemic period (Oct. - May), and measure of influenza morbidity / mortality to be modeled.  
```{r }
fludta %>% select(yrweek_dt, perc_fludeaths)
```

` fluserf() ` Will allow you to specify the boundaries for epidemic periods, and then compute the baseline off of non-epidemic timepoints. Additionally you can provide it with a logical variable in the dataset which indicates the epidemic period.  

### Example adding epidemic period indicator  
```{r }
fludta <- fludta %>%
  mutate(epi = if_else(month(yrweek_dt)>=10 | month(yrweek_dt)<=5, T, F))  

fludta %>%
  dplyr::filter(year>=2010)
```
We see that there is now an indicator for Oct - May.  

### Step 2. Fit predicted outcome and epidemic threshold   
Here we estimate a model using only non-epidemic period timepoints. The coefficients from this model will then be used to predict values during the epidemic period.  

#### Step 2a. Compute fourier terms  
```{r }
## Compute fourier terms
fludta_serfling <- fludta %>%
  mutate(week2 = row_number(),
         theta = 2*week2/52,
         sin_f1 = sinpi(theta),
         cos_f1 = cospi(theta))
```

#### Step 2b. Baseline Cyclical model  
Fit a model using non-epidemic periods, and excluding year 2015. This is the year we are focused on evaluating for excess mortality.  
```{r }
base_fit <- fludta_serfling %>%
  dplyr::filter(epi==F & year<2015) %>%
  lm(perc_fludeaths ~ week2 + sin_f1 + cos_f1, 
     data=., na.action = na.exclude)
```
Fit a model using only non-epidemic periods.  

### Note regarding standard errors.  
By default R's predict.lm will fit a 95% prediction interval. In Serfling's original paper it states:  

> "The epidemic threshold...is placed at a distance of 1.64 standard 
> deviations above the trend line, a level which experience has shown 
> to be useful for distinguishing epidemic increase from random variation."

The CDC also describes the threshold as:

> "The seasonal baseline of P&I deaths is calculated using a periodic 
> regression model that incorporates a robust regression procedure applied to
> data from the previous five years.  An increase of 1.645 standard deviations > above the seasonal baseline of P&I deaths is considered the 'epidemic 
> threshold,' i.e., the point at which the observed proportion of deaths 
> attributed to pneumonia or influenza was significantly higher than would be
> expected at that time of the year in the absence of substantial 
> influenza-related mortality."

` fluserf ` follows this method, but the modified serfling function allows for more options for threshold prediction. 1.645 standard deviations is equal to a one-sided upper limit 95% confidence interval.  

#### Step 2c. Add predicted values to original dataset.  
```{r }
## Fitted values + prediction interval
df_pred <- fludta_serfling %>%
  dplyr::filter(year==2014 & week>=40 | year>2014) %>%
  predict(base_fit, newdata=., se.fit=TRUE, 
          interval="confidence", level=0.90) #must specify 0.9 bc two-sided

pred_y0 <- df_pred$fit[,1] #fitted values
pred_y0_serf <- df_pred$fit[,3] 

df_base <- fludta %>%
  dplyr::filter(year==2014 & week>=40 | year>2014) %>%
  add_column(., pred_y0, pred_y0_serf)  

df_base %>% select(year, week, perc_fludeaths, 
                   pred_y0, pred_y0_serf)  
```

```{r, echo=F, results='as.is', fig.width=7}
#Set up graph labels, line specs
line_names <- c("% Deaths From P&I", "Expected %", "Epidemic Threshold")
line_cols <- c("#CC0000", "black", "black")
line_types <- c(1, 1, 2)
names(line_cols) <- line_names
names(line_types) <- line_names
  
ggplot(df_base, aes(x=yrweek_dt)) + 
  geom_line(aes(y=perc_fludeaths, colour=line_names[[1]], 
                linetype=line_names[[1]]), size=0.8) +
  geom_line(aes(y=pred_y0, colour=line_names[[2]], 
                linetype=line_names[[2]]), size=0.8) +
  geom_line(aes(y=pred_y0_serf, colour=line_names[[3]], 
                linetype=line_names[[3]]), size=0.8) +
  scale_colour_manual("Line", breaks=line_names, values = line_cols) +
  scale_linetype_manual("Line", breaks=line_names, values = line_types) +
  scale_x_date(labels = date_format("%b"), date_breaks="1 month",
               expand=c(0, .9)) + 
  xlab("2014 - 2015 Influenza Season") + ylab("% of Deaths from P&I") + 
  theme_light(base_size=14) +
  theme(legend.text=element_text(size=10), 
        plot.title = element_text(size=14)) +
  labs(title="Figure 4. Pneumonia and Influenza Mortality") +
  guides(colour = guide_legend("Line"), linetype = guide_legend("Line"))
```

**% of Deaths from P&I** - No. of influenza or pneumonia deaths / total number of deaths *100.  
**Expected %** - A fit of the cyclical regression model, (one Fourier term).  
**Epidemic Threshold** - The fitted line + 1.64 standard deviations.  

### Step 3. Compute excess deaths    
The next step is to determine the difference in % of deaths in excess of the epidemic threshold.  

```{r }
df_excess <- df_base %>%
  mutate(threshold = if_else(perc_fludeaths > pred_y0_serf, T, F),
         simple_excess = if_else((perc_fludeaths - pred_y0_serf)>0,
         perc_fludeaths - pred_y0_serf, 0))
```

In addition to being in excess, Serfling applies a rule that values are counted starting from two consecutive timepoints exceeding the threshold, then stopped after two timepoints below the threshold. This rule is problematic depending on how the period is programmed, if the unit of observation is more granular (day or week) then the rule will have more false-positives, if less granular (i.e. month) if will have false-negatives.  

## Serfling consecutive rule
We show how to implement this below, however recommend that it not be used routinely.  

```{r }
## Identify consecutive epidemic periods  
  df_serf_excess <- df_excess %>%
    mutate(serf_rule = if_else(threshold==T & 
                                 lead(threshold)==T & 
                                 lag(threshold)==T, T, F))
##reset beginning and end periods
  df_serf_excess <- df_serf_excess %>%
    mutate(serf_rule = if_else(serf_rule==F & 
                                 threshold==T & 
                                 lead(serf_rule)==T, T, serf_rule),
           serf_rule = if_else(serf_rule==F, 
                               threshold==T & 
                               lag(serf_rule)==T, T, serf_rule))
  
 ##compute excess deaths
   df_serf_excess <- df_serf_excess %>%
     mutate(serf_excess = if_else(serf_rule==T, 
                                  perc_fludeaths - pred_y0_serf, 0))


df_serf_excess %>% select(year, week, threshold, simple_excess, serf_rule, serf_excess)
```

Note how for weeks 29 and 31, the Serfling rule discounts the excess mortality.  

```{r, echo=F, results='as.is', fig.width=7.0}
ggplot(df_serf_excess, aes(x=yrweek_dt)) + 
  geom_line(aes(y=simple_excess, colour="Excess mortality"), size=0.8, linetype=2) +
  geom_line(aes(y=perc_fludeaths, colour="Reported mortality"), size=0.8, linetype=1) +
  scale_x_date(labels = date_format("%b"), date_breaks="1 month",
               expand=c(0, .9)) + 
  scale_colour_manual("Line",
                      values = c("Excess mortality"="#CC0000", 
                                 "Reported mortality"="black")) +
  xlab("2014- 2015 Influenza Year") + 
  ylab("% Deaths from P&I") + 
  theme_light(base_size=16) +
  theme(plot.title = element_text(size=14)) +
  labs(title="Figure 5. Periods of excess mortality over time")
```

## fluserf() function
```{r }
##The following command completes the above steps 
##fit serfling model
flu_fit <- fluserf(data=fludta, outc=perc_fludeaths, time=yrweek_dt)
flu_fit
```

### Plot function fluplot  
```{r, results='as.is', fig.width=7.0}
fluplot(flu_fit, xvar=yrweek_dt, perc_fludeaths, y0, y0_ul,
                    ylab="% Deaths from P&I", title="Serfling Model")
```

## Criticisms of this approach  

The historical Serfling model should be considered as important background and an useful educational tool. But probably not applied in an research project.  

 * The authors view the approach as a pragmatic one in the context of the 1960s when computation was difficult, but its implementation is now somewhat dated given modern computing methods. The constrains of needing an easy to estimate linear model are no longer relevant to the modern analyst. The use of a Fourier term to obtain fitted estimates and coefficients for "off-season" timepoints, then construct fitted lines for "on-season" timepoints makes many untested assumptions about the functional form and fixed parameters of seasonal influenza trend lines.  
 
 * More elegant models (e.g. ARIMA, splines) are now available which may overcame the above limitations, and make fewer assumptions about the functional form.  
 
 * Additionally the approach is dependent on an accurate baseline period. Whether to include mild or known epidemic seasons, which cut-off to define as the influenza season (e.g. week 40 - week 20) are important but subjective decisions the analyst must make.  
 
 * The selected threshold for what constitutes "excess" is somewhat arbitrary. The original Serfling paper describes 1.64 standard deviations for 2 or more weeks as criteria. Recent papers have used the 95% prediction interval.   
 
# References  
```{r }
sessioninfo::session_info()
```