---
title: "Serfling Model Background"
author: "Kevin W. McConeghy"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Serfling Model Background}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The primary method paper was a 1963 paper published by Robert Serfling from the Centers for Disease Control and Prevention.  

[Serfling RE. Methods for current statistical analysis of excess pneumonia-influenza deaths. Public Health Rep. 1963 Jun; 78(6): 494 - 506.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1915276/)

The paper outlines a strategy for estimating the proportion of deaths are due to influenza. The primary goal was to develop a "standard curve of expected seasonal mortality". The concept was that an individual could use historical data to estimate seasonal trends in influenza. Then for a given place-time an researcher could evaluate how many deaths occurred in excess of this baseline rate. Much of the original paper is of little interest given modern computing methods, but the basic concept persists as a reasonable approach to estimating "flu" deaths.      

## Influenza  
Critically, it should be understood that influenza epidemics are highly seasonal with spikes in the winter months, commonly January - February. This seasonality leads to a cyclical rate of influenza morbidity and mortality.  
```{r }
setwd("~/GitHub/flumodelr/")
library(dplyr)
library(ggplot2)
library(lubridate)
library(scales)

load(paste0(getwd(), "/data/cdc122city.rda"))

## Make Example Figure 
weekly <- cdc122city %>%
  group_by(year, week) %>%
  summarize(fludeaths = mean(deaths_pnaflu, na.rm=T)) %>%
  mutate(yrweek_dt = as.POSIXct(paste0(year, "-", week, "-", "1"), format = "%Y-%U-%u"),
         yrweek_dt = as_date(yrweek_dt)) %>%
  filter(year>=2010)

g1 <- ggplot(weekly, aes(x=yrweek_dt, y=fludeaths)) + 
  geom_line(size=0.8, colour="#CC0000") +
  scale_x_date(labels = date_format("%Y-%b"), date_breaks="1 year",
               expand=c(0, .9)) + 
  xlab("Year-month") + 
  ylab("Deaths per 100,000") + 
  theme_light(base_size=16)
g1
```

It was noted by early researchers that the cyclical rate (red line), could be modeled by a mathematical function. 

## Linear and Cyclical Regression Models 

The classical ordinary least squares framework is often described in matrix notation as:  
$$y_i = X_i\beta + u_{i} \quad \textrm{where} \quad i = 1,..,n$$

Where $y$ is a dependent variable, $X$ is a vector of regressors (i.e. independent variables) with $k$-dimensions, $\beta$ is a vector of the coefficients for $X$, and $u$ is the residual error term.  often simply as: $y= X\beta+u$.  

Given a simple additive model with one independent variable x:
$$Eq \ 1. \  y = \alpha_0 + \beta_1*x_1 + u$$

Assume x, is the rate of influenza in as simple time-series.  The above model is inadequate, and will poorly fit the above figure.  

Early investigators including Serfling proposed that a Fourier term be added to model the cycle like so:
$$Eq \ 2. \  y = \alpha_0 + \beta_1*t + sine(\frac{2 \pi t}{52}) + cos(\frac{2 \pi t}{52}) + u$$
This allows us to estimate a linear model which accounts for the cyclical nature of the disease.  The original paper recommends one Fourier term (i.e. sine/cos pair). However, this was a pragmatic decision, and modern approaches could easily incorporate more. 

See: https://en.wikipedia.org/wiki/Fourier_series for background on Fourier terms.  

## Estimation approach  

The serfling paper describes 4 steps:

 * Estimate secular trend  
 * Remove trend from data  
 * Estimate seasonal change from adjusted data  
 * Restore trend component  
 
In this package we operationalize this like so:

 * Given a time-series dataset; with a variable for a flu outcome (i.e. deaths, hospitalizations).  
 * Estimate a cyclical regression as above; 
  * predict outcome rate  (solid black line)
  * predict outcome rate + 1.64 standard deviations (dashed black line)
 * Observations falling outside the dashed black line are "excess"  
  * Compute the difference between the observed - predicted  
 
## Criticisms of this approach  

We see the following problems with this approach the reader should consider:  

 * The authors view the concept as sound, but its implementation in the original work is somewhat dated given modern computing methods. The constrains of needing an easy to estimate linear model are no longer relevant to the modern analyst. More elegant models (e.g. ARIMA) which may better account for seasonal spikes (i.e. epidemics) are probably an overall better approach. 
 
 * Additionally the approach is dependent on an accurate baseline period. Whether to include mild or known epidemic seasons is an important but subjective decision the analyst must make.  
 
 * The selected threshold for what constitutes "excess" is somewhat arbitrary. The original Serfling paper describes 1.64 standard deviations for 2 or more weeks as criteria. There is not an evidence for this, but a threshold is needed and the argument is pragmatic and logical.  